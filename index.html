<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#064e3b">
    <title>Sistem Khairat Pintar</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #064e3b; --accent: #f59e0b; --bg: #f0fdf4; --card-bg: #ffffff; --text: #1e293b; --red: #ef4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }

        /* HEADER */
        .header {
            background: linear-gradient(160deg, var(--primary) 0%, #047857 100%);
            color: white; padding: 40px 20px 80px; border-radius: 0 0 35px 35px;
            text-align: center; box-shadow: 0 4px 20px rgba(6, 78, 59, 0.3);
        }
        .app-title { font-size: 1.6rem; font-weight: 800; margin: 0; line-height: 1.2; }
        .app-slogan { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; font-weight: 500; }

        /* CARIAN BOX */
        .search-card {
            background: white; width: 90%; max-width: 500px; margin: -50px auto 20px;
            padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            position: relative; z-index: 10;
        }
        .input-ic {
            width: 100%; padding: 15px; font-size: 1.2rem; text-align: center; font-weight: 700;
            border: 2px solid #cbd5e1; border-radius: 12px; outline: none; transition: 0.3s;
            color: var(--primary); letter-spacing: 2px;
        }
        .input-ic:focus { border-color: var(--accent); background: #fffbeb; }
        .btn-cari {
            width: 100%; background: var(--primary); color: white; padding: 15px;
            border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700;
            margin-top: 10px; cursor: pointer; transition: 0.2s;
        }
        .btn-cari:active { transform: scale(0.98); }

        /* RESULT CARD */
        #result-view { display: none; padding: 0 15px; max-width: 500px; margin: 0 auto; }
        .member-card {
            background: white; border-radius: 18px; padding: 25px;
            border: 1px solid #e2e8f0; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .status-pill {
            display: inline-block; padding: 8px 20px; border-radius: 50px;
            font-weight: 800; font-size: 0.9rem; margin-bottom: 15px;
        }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-alert { background: #fee2e2; color: #991b1b; }

        .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1rem; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px; }
        .info-label { color: #64748b; font-size: 0.9rem; }
        .info-val { font-weight: 700; text-align: right; }

        /* ACTIONS */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-act { padding: 12px; border-radius: 12px; text-align: center; text-decoration: none; font-weight: 700; font-size: 0.9rem; display: block; }
        .btn-wa { background: #25D366; color: white; }
        .btn-waris { background: white; border: 2px solid #f97316; color: #f97316; }

        /* FOOTER INFO */
        .footer-info { margin-top: 30px; text-align: center; font-size: 0.85rem; color: #64748b; padding: 20px; }
        .ticker-box { background: #fff7ed; color: #c2410c; padding: 10px; font-size: 0.85rem; font-weight: 600; text-align: center; border-bottom: 1px solid #ffedd5; }
    </style>
</head>
<body>

    <div id="ticker" class="ticker-box">Memuatkan pengumuman...</div>

    <div class="header">
        <div style="font-size:3rem; margin-bottom:10px;">üïå</div>
        <h1 id="appTitle" class="app-title">SISTEM KHAIRAT</h1>
        <p id="appSlogan" class="app-slogan">...</p>
    </div>

    <div class="search-card">
        <label style="display:block; text-align:center; color:#64748b; margin-bottom:5px; font-size:0.9rem;">Masukkan No. Kad Pengenalan</label>
        <input type="number" id="inputIc" class="input-ic" placeholder="Contoh: 800123..." onkeyup="checkEnter(event)">
        <button onclick="cariAhli()" class="btn-cari" id="btnSearch">SEMAK STATUS</button>
    </div>

    <div id="result-view">
        <div class="member-card">
            <div style="text-align:center;">
                <span id="pillStatus" class="status-pill status-ok">AKTIF</span>
            </div>
            
            <h2 id="viewNama" style="text-align:center; margin:0 0 5px; color:var(--primary);">...</h2>
            <p id="viewNoAhli" style="text-align:center; color:#64748b; margin:0 0 20px;">No. Ahli: ...</p>

            <div class="info-row">
                <span class="info-label">Kawasan</span>
                <span id="viewKawasan" class="info-val">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Tahun Terakhir Bayar</span>
                <span id="viewTahun" class="info-val">-</span>
            </div>
            
            <div id="boxTunggakan" style="background:#fef2f2; padding:15px; border-radius:10px; margin-top:15px; display:none;">
                <strong style="color:#ef4444; display:block; margin-bottom:5px;">‚ö†Ô∏è PERLU DIBAYAR</strong>
                <div style="display:flex; justify-content:space-between; font-size:1.1rem; font-weight:800; color:#991b1b;">
                    <span id="labelTunggakan">Tunggakan (1 Tahun)</span>
                    <span id="valTunggakan">RM 50</span>
                </div>
            </div>

            <div style="margin-top:20px; background:#f8fafc; padding:15px; border-radius:10px;">
                <small style="color:#64748b; font-weight:700; display:block; margin-bottom:5px;">WARIS BERDAFTAR</small>
                <div style="font-weight:700; color:#334155;" id="viewWaris">-</div>
            </div>

            <div class="action-grid">
                <a id="btnCallWaris" href="#" class="btn-act btn-waris">üìû Hubungi Waris</a>
                <a id="btnWhatsapp" href="#" class="btn-act btn-wa">üí¨ WhatsApp Ahli</a>
            </div>
        </div>
    </div>

    <div class="footer-info">
        <strong style="display:block; color:var(--text); font-size:1rem; margin-bottom:5px;">INFO PEMBAYARAN</strong>
        <span id="viewBank">...</span><br>
        <span id="viewAkaun" style="font-size:1.2rem; font-weight:800; color:var(--primary);">...</span><br><br>
        
        <a id="linkDaftar" href="#" style="background:var(--text); color:white; padding:10px 25px; border-radius:50px; text-decoration:none; font-weight:700;">
            üìù Daftar Ahli Baru
        </a>
        <br><br>
        Hubungi Admin: <a id="linkAdmin" href="#" style="color:var(--primary); font-weight:700; text-decoration:none;">...</a>
    </div>

    <script>
        // ===========================================
        // PASTE LINK WEB APP SCRIPT ANDA DI SINI
        // ===========================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwXpTaJt5pf70SF-aDGAzqra8sLnft0MM5gTaxv3Y7LQoQZ7we0lex8mArpeMngba-p/exec';
        
        // GLOBAL VARIABLES
        let YURAN_TAHUNAN = 50; 

        // 1. INIT: TARIK SETUP DARI EXCEL
        document.addEventListener('DOMContentLoaded', () => {
            fetch(SCRIPT_URL + '?action=getSettings')
            .then(res => res.json())
            .then(data => {
                // Masukkan data ke UI
                document.getElementById('appTitle').innerText = data.NamaMasjid;
                document.getElementById('appSlogan').innerText = data.Slogan;
                document.getElementById('ticker').innerText = data.Pengumuman;
                
                document.getElementById('viewBank').innerText = data.NamaBank;
                document.getElementById('viewAkaun').innerText = data.NoAkaun;
                
                document.getElementById('linkDaftar').href = data.LinkBorang;
                document.getElementById('linkAdmin').innerText = "0" + data.TelAdmin;
                document.getElementById('linkAdmin').href = "https://wa.me/" + data.TelAdmin;

                YURAN_TAHUNAN = parseInt(data.YuranTahunan); // Simpan nilai yuran
            });
        });

        // 2. FUNGSI CARI AHLI
        function cariAhli() {
            const ic = document.getElementById('inputIc').value;
            if(!ic) return alert("Sila masukkan No. IC");

            const btn = document.getElementById('btnSearch');
            btn.innerHTML = "SEDANG SEMAK...";
            btn.disabled = true;

            fetch(SCRIPT_URL + '?action=search&ic=' + ic)
            .then(res => res.json())
            .then(data => {
                btn.innerHTML = "SEMAK STATUS";
                btn.disabled = false;

                if(!data) return alert("Rekod tidak dijumpai. Sila hubungi admin.");

                // Papar Data
                document.getElementById('result-view').style.display = 'block';
                document.getElementById('viewNama').innerText = data.Nama;
                document.getElementById('viewNoAhli').innerText = "#" + data.NoAhli;
                document.getElementById('viewKawasan').innerText = data.Kawasan;
                document.getElementById('viewTahun').innerText = data.TahunAkhir;
                document.getElementById('viewWaris').innerText = data.Waris;

                // LOGIK PINTAR: KIRA HUTANG
                const currentYear = new Date().getFullYear();
                const lastPay = parseInt(data.TahunAkhir);
                const hutangTahun = currentYear - lastPay;

                // Setup Status
                const pill = document.getElementById('pillStatus');
                const boxHutang = document.getElementById('boxTunggakan');

                if (data.Status === "Meninggal") {
                    pill.className = "status-pill status-alert";
                    pill.innerText = "MENINGGAL DUNIA";
                    boxHutang.style.display = 'none';
                } 
                else if (hutangTahun > 0) {
                    // Ada Tunggakan
                    pill.className = "status-pill status-alert";
                    pill.innerText = "TUNGGAKAN";
                    
                    const jumlahHutang = hutangTahun * YURAN_TAHUNAN;
                    
                    boxHutang.style.display = 'block';
                    document.getElementById('labelTunggakan').innerText = `Tunggakan (${hutangTahun} Tahun)`;
                    document.getElementById('valTunggakan').innerText = `RM ${jumlahHutang}`;
                } else {
                    // Bersih
                    pill.className = "status-pill status-ok";
                    pill.innerText = "AKTIF / LUNAS";
                    boxHutang.style.display = 'none';
                }

                // Setup Buttons
                document.getElementById('btnWhatsapp').href = `https://wa.me/6${data.NoTelefon}`;
                document.getElementById('btnCallWaris').href = `tel:${data.TelWaris}`;

                // Scroll ke bawah
                document.getElementById('result-view').scrollIntoView({behavior: 'smooth'});
            });
        }

        function checkEnter(e) {
            if(e.key === "Enter") cariAhli();
        }
    </script>
</body>
</html>
